# Presentation Layer Refactoring Plan

## 現状の問題点

1. **コードの重複**: 
   - 同様のUIコンポーネント（ボタンスタイル、テーブルセルなど）が複数のファイルで重複して定義されている
   - 同じ状態管理のコードが複数の場所に存在する

2. **責任の混在**:
   - UIコンポーネントにビジネスロジックが含まれている
   - 表示ロジックと状態管理が密結合している

3. **状態管理の不一致**:
   - Riverpodを使用しているが、状態管理の方法が一貫していない
   - 同様の状態管理のコードが複数の場所で異なる方法で実装されている

4. **画面遷移ロジックの散在**:
   - 画面遷移ロジックがUIコンポーネントに混在している
   - `popCount`のような変数がグローバルに定義されている

5. **ハードコードされたUI要素**:
   - 多くのUI要素がハードコードされたスタイルや値を持っている
   - テーマデータや定数を使用していない箇所が多い

## リファクタリング計画

### 1. 共通UIコンポーネントの抽出

#### 1.1 ボタンコンポーネント
- 共通のボタンスタイルを`lib/presentation/common/components/buttons.dart`に抽出
  - `PrimaryButton`
  - `SecondaryButton`
  - `OutlinedAppButton`
  - `ToggleButton`

#### 1.2 テーブルコンポーネント
- 気分値目安表のコンポーネントを整理
  - 既存の`WorksheetTableCell`を拡張して再利用性を高める
  - 共通の`Divider`スタイルを抽出

#### 1.3 ダイアログとモーダル
- 既存のダイアログコンポーネントを整理
- 入力モーダルの共通化

### 2. 状態管理の統一

#### 2.1 Providerの整理
- 重複したProviderの統合
  - `selectedMoodButtonStateProvider`の重複を解消
  - 各ページで定義されている類似のProviderを統合

#### 2.2 状態管理パターンの統一
- Riverpodの使用パターンを統一
  - 状態の読み取りと更新の一貫したパターンを確立
  - `StateNotifierProvider`と`StateProvider`の使い分けを明確化

### 3. ビジネスロジックの分離

#### 3.1 プレゼンテーションロジックの抽出
- UIコンポーネントからビジネスロジックを分離
  - 表示ロジックとデータ処理ロジックを分離
  - コントローラークラスの導入

#### 3.2 ユースケースの活用
- 既存のユースケースを適切に活用
  - UIコンポーネントから直接ユースケースを呼び出す代わりに、コントローラーを介して呼び出す

### 4. 画面遷移ロジックの整理

#### 4.1 ナビゲーションサービスの強化
- 既存の`PageNavigator`を拡張
  - 画面遷移の状態管理を改善
  - グローバル変数（`popCount`など）の排除

#### 4.2 ルーティングの一元管理
- アプリ全体のルーティングを一元管理する仕組みの導入
  - 名前付きルートの活用
  - 遷移パラメータの型安全な受け渡し

### 5. 国際化対応の改善

#### 5.1 国際化の一貫した使用
- `S.of(context)`の使用パターンを統一
- 文字列リソースの整理と統合

## 実装順序

1. 共通UIコンポーネントの抽出
2. 状態管理の統一
3. ビジネスロジックの分離
4. 画面遷移ロジックの整理
5. 国際化対応の改善

## テスト戦略

- 各リファクタリングステップ後にアプリをビルドし、エラーがないことを確認
- UIの見た目や機能に変更がないことを確認
- 既存の機能が正常に動作することを確認

## 期待される効果

- コードの重複が減少し、保守性が向上
- コンポーネントの再利用性が高まる
- 責任の分離により、テストが容易になる
- 一貫した設計パターンにより、新機能の追加が容易になる
- コードの可読性と理解しやすさが向上
